# SD Tag Converter Pro - 開発・運用マニュアル

本ドキュメントは、Stable Diffusion 向けプロンプトエディタ「SD Tag Converter Pro」の開発者、および管理者向けのシステム仕様・運用マニュアルです。エンドユーザー向けの使い方については、[readme.html](readme.html) を参照してください。

---

## 1. システム概要と技術スタック

本システムは、Danbooru のタグ出現頻度データに基づき、プロンプトの評価・色分け・直感的な並び替えを提供する完全静的 Web アプリケーションです。

- **フロントエンド:** HTML5, CSS3, Vanilla JavaScript（外部ライブラリ非依存）
- **データソース:** JSON ファイル（起動時に非同期でフェッチ）
- **ホスティング:** Cloudflare Pages
- **ローカル開発環境:** Python (`http.server` または Flask 等) ＋ バッチスクリプト

---

## 2. ディレクトリ・ファイル構成

主要なファイル群とその役割は以下の通りです。

| ファイル名                | 役割                                                                                                   |
| :------------------------ | :----------------------------------------------------------------------------------------------------- |
| `index.html`              | アプリケーション本体。UI 描画、パース処理、ドラッグ＆ドロップなどの全ロジックを単一ファイルに集約。    |
| `readme.html`             | エンドユーザー向けの操作マニュアル。                                                                   |
| `sd_syntax_guide.html`    | SD 特有の構文ルールや特殊タグに関する解説ページ。                                                      |
| `danboru_dictionary.json` | タグの出現頻度、翻訳、しきい値などをまとめた本番用マスターデータ。                                     |
| `thresholds.json`         | 色分けのしきい値（minCount, maxCount, colorCode 等）を定義する設定ファイル。                           |
| `data.tsv`                | Danbooru タグの元データ（tag, trans, jpTag, count, tagGroup 等をタブ区切りで保持）。                   |
| `update_data.py`          | `data.tsv` と `thresholds.json` を結合・変換し、`danboru_dictionary.json` を生成するビルドスクリプト。 |
| `start_server.bat`        | ローカル開発用の簡易 Web サーバー起動バッチ。                                                          |
| `server.py`               | DB 接続等を含む高度なローカルサーバー（必要に応じて使用）。                                            |

---

## 3. コア機能と詳細設計（JavaScript ロジック）

本ツールは、Stable Diffusion の構文ルールを破壊しないため、`index.html` 内に高度な専用パーサー（`splitTagsSmart`等）を実装しています。コード改修時は以下の仕様を厳守してください。

### 3.1 括弧内のカンマ保護処理

`()`, `[]`, `{}`, `<>` のネスト深度（`depth`, `angle`）をカウントし、括弧内に含まれるカンマでは文字列を分割しない仕様です。これにより、`[tag1:tag2:0.5]` や `(tag, tag:1.2)` などの構文が破壊されるのを防ぎます。

### 3.2 特殊タグ・制御タグの結合仕様

`<lora:...>` などの特殊タグ、および `BREAK`, `AND`, `ADDROW`, `ADDCOMM`, `ADDCOL`, `ADDBASE` などの制御タグは以下のロジックで処理されます。

- **描画:** 視認性向上のため、角が直角（`border-radius: 4px`）のピンク色のピル（#e84393）としてレンダリングされます。
- **同期・再構築:** これらを出力データとして再構築（`syncPreviewToData`）する際、**前後のタグとはカンマを使用せず、半角スペースのみで結合**されます（例: `BREAK ADDCOMM`）。※ただし、`BREAK` の前のタグにはカンマが付与されます。

### 3.3 コメントアウト機能の処理 (`#`)

- パース前に、行内の最初の `#` を検知し、それ以降を「分割しない 1 つのコメントブロック」として抽出します。
- 角が直角の緑色のピル（#27ae60）として描画されます。
- ドラッグ＆ドロップで行の途中に配置された場合、再構築時にもそのまま出力されます（SD の仕様上、その後ろに続くタグは無効化されますが、これを許容・利用する設計です）。

### 3.4 複合タグのフォールバック評価

`evaluateInternalParts` 関数により、`white_skirt` などの複合タグがマスターデータに完全一致しない場合、アンダースコアやスペース単位で分解して個別（`white`, `skirt`）に評価・色分けします。

---

## 4. 初期セットアップ（ローカル開発環境）

開発やテストを行うためのローカル環境構築手順です。

1. 本リポジトリ（フォルダ）を任意のディレクトリに配置します。
2. 同梱されている `start_server.bat` をダブルクリックして実行します。
3. コマンドプロンプトが立ち上がり、Python の `http.server`（ポート 8000）が起動します。
4. ブラウザで `http://localhost:8000/index.html` にアクセスし、動作確認を行います。

> ※ CORS エラーを回避するため、`index.html` を直接ブラウザにドラッグ＆ドロップして開く（`file:///` プロトコル）のではなく、必ず Web サーバー経由でアクセスしてください。

---

## 5. 辞書データの更新手順（運用保守）

タグの出現頻度の変動や、新しいタグ・しきい値を追加する場合の更新フローです。HTTP リクエスト回数を削減するため、タグデータとしきい値データは 1 つの JSON に結合して運用します。

1. **元データの準備・更新**

   - タグ情報を更新する場合は、最新のデータを取得して `data.tsv` を上書きします。
   - 色分けのしきい値やカテゴリを変更する場合は、`thresholds.json` を編集します。

2. **マスターデータのビルド**

   - コマンドライン（ターミナル）を開き、プロジェクトのルートディレクトリで以下のコマンドを実行します。
     ```bash
     python update_data.py
     ```
   - スクリプトが成功すると、`data.tsv` と `thresholds.json` の内容がマージされた最新の `danboru_dictionary.json` が生成されます。

3. **ローカルテスト**

   - `start_server.bat` を起動してローカル環境でツールを開き、検索機能や凡例（Legend）の色分けが意図通りに反映されているか確認します。

4. **本番環境へのデプロイ**
   - 更新された `danboru_dictionary.json`（および必要に応じて改修した `index.html` など）をリポジトリにコミット・プッシュし、Cloudflare Pages へデプロイして作業完了です。

# 2026-02-26 16:51 更新分

# SD Visual Prompt Editor ユーザーマニュアル

Stable Diffusion 向けのプロンプト（タグ）を、Danbooru のタグ出現頻度に基づいて評価・色分けし、直感的なビジュアルエディタで操作・自動整形できる Web ツールです。

## 1. ツールの起動と画面構成

本ツールはローカル環境で動作する軽量なアプリケーションです。データベースやバックエンドサーバーの構築は不要です。

- **起動方法**

  1. フォルダ内の `start_server.bat` を実行します。
  2. コマンドプロンプトに表示される URL（例: `http://localhost:8000/index.html`）をブラウザで開きます。

- **画面構成**
  - **ヘッダー:** ダークモード切替、データ読み込みステータス、マニュアルへのリンク。
  - **入力ペイン（上部）:** テキストベースのプロンプトや、スプレッドシートデータの入力・出力領域。
  - **ビジュアルエディタ（下部）:** ドラッグ＆ドロップでタグを組み立てるワークスペース。
  - **タグ検索パレット（右側）:** 辞書からのタグ検索、エディタへの投入。

---

## 2. メイン機能の使い方（タブ別）

### A. 「プロンプトエディタ」タブ

テキストエディタや WebUI から、カンマ区切りのプロンプトを貼り付ける基本モードです。

1. **↓ 反映:** テキストエリアにプロンプトを入力し、「↓ ビジュアルエディタに反映」ボタンを押すとタグが視覚化されます。
2. **編集:** ビジュアルエディタ上でドラッグ＆ドロップによる並び替え、追加、削除を行います。
3. **↑ 戻す:** 「↑ プロンプトエディタに反映」ボタンを押すと、編集後の状態がテキストエリアに上書きされます。

### B. 「スプレッドシート」タブ

表計算ソフトで管理している「カテゴリ名 ＋ タブ区切りのタグ」を一括で読み込み・書き出しするモードです。

1. **入力:** 見出し行を除いたデータ部分をコピーし、テキストエリアに貼り付けます。
2. **統合表示:** 「↓ ビジュアルエディタに反映」を押すと、カテゴリ名が `# カテゴリ名` というコメントブロックに変換され、すべてのプロンプトが 1 つのキャンバス上に展開されます。
3. **↑ スプレッドシートへの書き戻し:**
   - 「↑ スプレッドシートに反映」を押すと、タブ区切り（TSV）データとして出力されます。
   - **「コメントアウトを除去」がオフの場合:** 緑色のコメントブロックを検知し、自動的に TSV の 1 列目（カテゴリ列）として復元して出力します。

---

## 3. ビジュアルエディタの強力な操作

出力ペインである「ビジュアルエディタ」は、完全なノーコードエディタとして機能します。

- **ドラッグで追加:** 右側の「タグ検索パレット」からタグを掴み、エディタ内の好きな場所にドロップして挿入できます（空白に落とすと新規行が作成されます）。
- **枠外ドロップで削除:** 不要になったタグや行全体は、掴んで**エディタの枠外へドロップする**だけで DOM から削除できます。
- **動的 BREAK 付加:** 「行末に BREAK を付加」のチェックボックスを操作すると、エディタ上の全行末の `BREAK` タグがリアルタイムに出現・消失します。

---

## 4. 特殊な構文の保護と管理

本ツールは Stable Diffusion の構文を破壊しないための専用パーサーを備えています。

- **カッコ内のカンマ保護:** `(red hair, blue eyes:1.2)` などの強調構文は分割されず維持されます。
- **制御タグの分離と結合:** `BREAK`, `AND` や `<lora:...>` などのタグは、ピンク色の四角いピルとして独立して扱われ、テキスト出力時には不要なカンマを付けずスペースでスマートに結合されます。
- **コメントアウト (#):** 緑色の四角いピルとして扱われます。これを行の途中に置くことで、SD の仕様を利用して意図的に後続のタグを無効化（テスト運用）するなどの応用が可能です。

---

## 5. アイコンやしきい値のカスタマイズ

- **アイコンの変更:** お好みの PNG 画像を `favicon-32x32.png` および `apple-touch-icon.png` という名前で保存し、ツールと同じフォルダに上書きしてください。
- **色分けの変更:** 同梱の `thresholds.json` をテキストエディタで編集し、カラーコードや基準回数を変更したのち、データ更新スクリプトを実行することで色分けルールをカスタマイズできます。
