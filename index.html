<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>SD Visual Prompt Editor</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png" />
    <link rel="apple-touch-icon" href="apple-touch-icon.png" />
    <style>
      :root {
        --bg-color: #f4f4f9;
        --text-color: #333;
        --accent-color: #4a90e2;
        --box-bg: #ffffff;
        --border-color: #ccc;
        --input-border: #ddd;
        --label-color: #2c3e50;
        --tab-bg: #ddd;
        --tab-active-bg: #ffffff;
        --sidebar-bg: #ffffff;
        --search-border: #4a90e2;
        --item-border: #eee;
        --legend-bg: #2c3e50;
        --legend-text: #fff;
        --copy-success-bg: #1e6031;
        --hover-bg: #e2e2e2;
        --tag-bg: #2b2b2b;
      }

      body.dark-mode {
        --bg-color: #121212;
        --text-color: #e0e0e0;
        --accent-color: #bb86fc;
        --box-bg: #1e1e1e;
        --border-color: #333;
        --input-border: #444;
        --label-color: #bb86fc;
        --tab-bg: #333;
        --tab-active-bg: #1e1e1e;
        --sidebar-bg: #1e1e1e;
        --search-border: #bb86fc;
        --item-border: #2c2c2c;
        --legend-bg: #333;
        --legend-text: #e0e0e0;
        --copy-success-bg: #0d3a1d;
        --hover-bg: #2a2a2a;
        --tag-bg: #252525;
      }

      body {
        font-family: sans-serif;
        margin: 20px;
        background-color: var(--bg-color);
        color: var(--text-color);
        max-width: 1400px;
        margin: auto;
        transition:
          background-color 0.3s,
          color 0.3s;
      }

      h2 {
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }
      .header-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }
      .help-link {
        color: var(--text-color);
        text-decoration: none;
        font-size: 0.85em;
        font-weight: bold;
        padding: 6px 12px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        background-color: var(--box-bg);
      }

      .donate-btn {
        color: #fff;
        text-decoration: none;
        font-size: 0.85em;
        font-weight: bold;
        padding: 6px 12px;
        border-radius: 4px;
        border: none;
        background-color: #ff5e5b;
        transition:
          background-color 0.2s,
          transform 0.1s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .donate-btn:hover {
        background-color: #e04845;
        transform: translateY(-1px);
      }

      .lang-switcher {
        display: flex;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        overflow: hidden;
      }
      .lang-btn {
        padding: 4px 8px;
        font-size: 0.75em;
        cursor: pointer;
        background: var(--tab-bg);
        border: none;
        color: var(--text-color);
      }
      .lang-btn.active {
        background: var(--accent-color);
        color: #fff;
      }

      .main-layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 340px;
        gap: 40px;
      }
      @media (max-width: 1000px) {
        .main-layout {
          grid-template-columns: 1fr;
        }
        .search-sidebar {
          position: static !important;
          width: 100% !important;
          box-sizing: border-box;
        }
      }

      .box-label {
        font-weight: bold;
        margin-bottom: 8px;
        display: block;
        color: var(--label-color);
      }

      .tab-container {
        display: flex;
        gap: 5px;
        margin-bottom: -1px;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        background: var(--tab-bg);
        border: 1px solid var(--border-color);
        border-bottom: none;
        border-radius: 6px 6px 0 0;
        font-weight: bold;
        font-size: 0.9em;
        color: var(--text-color);
      }
      .tab.active {
        background: var(--tab-active-bg);
        border-bottom: 2px solid var(--tab-active-bg);
        color: var(--accent-color);
      }

      .input-box {
        background: var(--box-bg);
        border: 1px solid var(--border-color);
        padding: 20px;
        border-radius: 0 6px 6px 6px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      textarea {
        width: 100%;
        height: 180px;
        font-family: "Consolas", monospace;
        font-size: 14px;
        padding: 12px;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        box-sizing: border-box;
        resize: vertical;
        background-color: var(--box-bg);
        color: var(--text-color);
      }

      .mini-copy-btn {
        position: absolute;
        top: 35px;
        right: 10px;
        padding: 4px 8px;
        font-size: 11px;
        background-color: var(--box-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        opacity: 0.7;
        transition: all 0.2s;
      }
      .mini-copy-btn:hover {
        opacity: 1;
        background-color: var(--hover-bg);
      }

      .preview-area {
        width: 100%;
        min-height: 250px;
        padding: 15px;
        background-color: var(--box-bg);
        color: var(--text-color);
        font-family: "Consolas", monospace;
        font-size: 14px;
        line-height: 1.6;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
        box-sizing: border-box;
      }

      .prompt-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border: 1px dashed transparent;
        border-radius: 4px;
        min-height: 40px;
      }
      .prompt-row:hover {
        border-color: var(--border-color);
        background-color: rgba(0, 0, 0, 0.02);
      }

      .prompt-tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        background-color: var(--tag-bg);
        border: 2px solid;
        border-radius: 20px;
        font-weight: bold;
        cursor: grab;
        user-select: none;
      }

      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        background: var(--box-bg);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .primary-btn {
        padding: 12px 24px;
        cursor: pointer;
        background-color: #fe66f1;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
      }
      .reflect-btn {
        padding: 12px 24px;
        cursor: pointer;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
      }
      .copy-btn {
        width: 100%;
        padding: 15px;
        background-color: #34a853;
        color: white;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        margin-bottom: 40px;
      }

      .legend-container {
        display: flex;
        gap: 8px;
        font-size: 0.8em;
        align-items: center;
        margin-left: auto;
        flex-wrap: wrap;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        border-radius: 20px;
        background: var(--legend-bg);
        color: var(--legend-text);
      }
      .color-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .search-sidebar {
        background: var(--sidebar-bg);
        padding: 20px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        position: sticky;
        top: 100px;
        align-self: start;
      }
      #tagSearch {
        width: 100%;
        padding: 12px;
        box-sizing: border-box;
        margin-bottom: 12px;
        border: 2px solid var(--search-border);
        border-radius: 4px;
        background: var(--box-bg);
        color: var(--text-color);
      }
      #searchResult {
        max-height: calc(100vh - 300px);
        overflow-y: auto;
      }
      .tag-item {
        padding: 10px;
        border-bottom: 1px solid var(--item-border);
        cursor: grab;
      }
    </style>
  </head>
  <body>
    <h2>
      <span id="ui-title">SD Visual Prompt Editor</span>
      <div class="header-controls">
        <a
          href="https://ko-fi.com/kotononeminazuki"
          target="_blank"
          class="donate-btn"
          id="ui-donate"
          >â˜• Support</a
        >
        <a href="readme.html" target="_blank" class="help-link" id="ui-help"
          >ğŸ“˜ Help</a
        >
        <a
          href="sd_syntax_guide.html"
          target="_blank"
          class="help-link"
          id="ui-syntax"
          >ğŸ“œ Syntax</a
        >

        <div class="lang-switcher">
          <button class="lang-btn" id="lang-ja" onclick="setLanguage('ja')">
            JP
          </button>
          <button class="lang-btn" id="lang-en" onclick="setLanguage('en')">
            EN
          </button>
        </div>

        <label style="font-size: 0.85em; font-weight: bold">
          <input
            type="checkbox"
            id="darkModeToggle"
            onchange="toggleDarkMode()"
          />
          <span id="ui-darkmode">ğŸŒ™ Dark</span>
        </label>
        <button
          id="statusBtn"
          class="refresh-btn"
          onclick="fetchFromDB()"
          style="
            background: var(--tab-bg);
            border: 1px solid var(--border-color);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-color);
          "
        >
          ğŸ”„ Loading...
        </button>
      </div>
    </h2>

    <div class="main-layout">
      <div class="converter-main">
        <div class="tab-container">
          <div id="tabNormal" class="tab active" onclick="switchTab('normal')">
            Editor
          </div>
          <div
            id="tabSpreadsheet"
            class="tab"
            onclick="switchTab('spreadsheet')"
          >
            Spreadsheet
          </div>
        </div>

        <div class="input-box">
          <div id="areaNormal" style="position: relative">
            <label class="box-label" id="ui-label-editor"
              >1. Prompt Editor</label
            >
            <button
              class="mini-copy-btn"
              onclick="copyResult('inputNormal', this)"
              id="ui-copy-1"
            >
              Copy
            </button>
            <textarea id="inputNormal" placeholder="1girl, solo..."></textarea>
          </div>
          <div id="areaSpreadsheet" style="display: none; position: relative">
            <label class="box-label" id="ui-label-tsv"
              >1. TSV / Spreadsheet Data</label
            >
            <button
              class="mini-copy-btn"
              onclick="copyResult('inputSpreadsheet', this)"
              id="ui-copy-2"
            >
              Copy
            </button>
            <textarea
              id="inputSpreadsheet"
              placeholder="Category	Tag1	Tag2..."
            ></textarea>
          </div>
        </div>

        <div class="controls">
          <button
            class="primary-btn"
            onclick="convert()"
            id="ui-btn-reflect-visual"
          >
            ğŸ”½ Reflect to Visual
          </button>
          <button
            class="reflect-btn"
            id="btnUpNormal"
            onclick="reflectToNormal()"
          >
            ğŸ”¼ Reflect to Editor
          </button>
          <button
            class="reflect-btn"
            id="btnUpSpreadsheet"
            onclick="reflectToSpreadsheet()"
            style="display: none"
          >
            ğŸ”¼ Reflect to TSV
          </button>

          <div id="stripOption" style="display: none; padding-left: 10px">
            <input type="checkbox" id="stripHeaders" />
            <label for="stripHeaders" id="ui-strip-headers"
              >Strip Comments</label
            >
          </div>
          <div id="breakOption" style="padding-left: 10px">
            <input type="checkbox" id="appendBreak" onchange="toggleBreaks()" />
            <label for="appendBreak" id="ui-append-break">Append BREAK</label>
          </div>
          <div id="legendArea" class="legend-container"></div>
        </div>

        <label class="box-label" id="ui-label-visual"
          >2. Visual Editor (Drag & Drop to sort/remove)</label
        >
        <div id="outputPreview" class="preview-area"></div>
        <button
          class="copy-btn"
          onclick="copyResult('outputRaw', this)"
          id="ui-btn-copy-prompt"
        >
          Copy as Prompt
        </button>
        <textarea id="outputRaw" style="display: none"></textarea>
      </div>

      <div class="search-sidebar">
        <label class="box-label" id="ui-label-search">Tag Search Palette</label>
        <input
          type="text"
          id="tagSearch"
          placeholder="Search keywords..."
          oninput="searchTags()"
          disabled
        />
        <div id="searchResult"></div>
      </div>
    </div>

    <script>
      let tagDatabase = [];
      let tagMap = new Map();
      let allThresholds = [];
      let currentLang = localStorage.getItem("lang") || "ja";

      const translations = {
        ja: {
          title: "SD Visual Prompt Editor",
          donate: "â˜• æ”¯æ´ã™ã‚‹",
          help: "ğŸ“˜ ä½¿ã„æ–¹",
          syntax: "ğŸ“œ SDæ§‹æ–‡",
          darkmode: "ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰",
          loading: "ğŸ”„ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...",
          success: "âœ… å–å¾—å®Œäº†: {n}ä»¶",
          error: "âŒ å–å¾—å¤±æ•—",
          tab_editor: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿",
          tab_tsv: "ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ",
          label_editor: "1. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿",
          label_tsv: "1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ/TSVãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘",
          label_visual:
            "2. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ (ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§è¿½åŠ ãƒ»ç§»å‹•ãƒ»æ å¤–ã¸å‰Šé™¤)",
          label_search: "ã‚¿ã‚°æ¤œç´¢ãƒ‘ãƒ¬ãƒƒãƒˆ",
          placeholder_editor:
            "1girl, solo, (looking at viewer:1.2), <lora:my_lora:1.0>...",
          placeholder_tsv: "ã‚«ãƒ†ã‚´ãƒªå	ã‚¿ã‚°1	ã‚¿ã‚°2...",
          placeholder_search: "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›...",
          btn_reflect_visual: "ğŸ”½ ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ã«åæ˜ ",
          btn_reflect_editor: "ğŸ”¼ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã«åæ˜ ",
          btn_reflect_tsv: "ğŸ”¼ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åæ˜ ",
          btn_copy_prompt: "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦ã‚³ãƒ”ãƒ¼",
          strip_headers: "ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’é™¤å»",
          append_break: "è¡Œæœ«ã«BREAKã‚’ä»˜åŠ ",
          copy: "ã‚³ãƒ”ãƒ¼",
          copied: "âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼",
          fail: "âŒ å¤±æ•—",
        },
        en: {
          title: "SD Visual Prompt Editor",
          donate: "â˜• Support",
          help: "ğŸ“˜ Help",
          syntax: "ğŸ“œ Syntax",
          darkmode: "ğŸŒ™ Dark Mode",
          loading: "ğŸ”„ Loading Data...",
          success: "âœ… Loaded: {n} tags",
          error: "âŒ Load Failed",
          tab_editor: "Prompt Editor",
          tab_tsv: "Spreadsheet",
          label_editor: "1. Prompt Editor",
          label_tsv: "1. TSV / Spreadsheet Data",
          label_visual: "2. Visual Editor (Drag & Drop to sort/remove)",
          label_search: "Tag Search Palette",
          placeholder_editor:
            "1girl, solo, (looking at viewer:1.2), <lora:my_lora:1.0>...",
          placeholder_tsv: "Category	Tag1	Tag2...",
          placeholder_search: "Search keywords...",
          btn_reflect_visual: "ğŸ”½ Reflect to Visual",
          btn_reflect_editor: "ğŸ”¼ Reflect to Editor",
          btn_reflect_tsv: "ğŸ”¼ Reflect to TSV",
          btn_copy_prompt: "Copy as Prompt",
          strip_headers: "Strip Comments",
          append_break: "Append BREAK",
          copy: "Copy",
          copied: "âœ… Copied!",
          fail: "âŒ Failed",
        },
      };

      window.onload = () => {
        initTheme();
        setLanguage(currentLang);
        fetchFromDB();
        initDragAndDrop();
      };

      function setLanguage(lang) {
        currentLang = lang;
        localStorage.setItem("lang", lang);
        document
          .getElementById("lang-ja")
          .classList.toggle("active", lang === "ja");
        document
          .getElementById("lang-en")
          .classList.toggle("active", lang === "en");

        const t = translations[lang];
        document.getElementById("ui-title").innerText = t.title;
        document.getElementById("ui-donate").innerText = t.donate;
        document.getElementById("ui-help").innerText = t.help;
        document.getElementById("ui-syntax").innerText = t.syntax;
        document.getElementById("ui-darkmode").innerText = t.darkmode;
        document.getElementById("tabNormal").innerText = t.tab_editor;
        document.getElementById("tabSpreadsheet").innerText = t.tab_tsv;
        document.getElementById("ui-label-editor").innerText = t.label_editor;
        document.getElementById("ui-label-tsv").innerText = t.label_tsv;
        document.getElementById("ui-label-visual").innerText = t.label_visual;
        document.getElementById("ui-label-search").innerText = t.label_search;
        document.getElementById("inputNormal").placeholder =
          t.placeholder_editor;
        document.getElementById("inputSpreadsheet").placeholder =
          t.placeholder_tsv;
        document.getElementById("tagSearch").placeholder = t.placeholder_search;
        document.getElementById("ui-btn-reflect-visual").innerText =
          t.btn_reflect_visual;
        document.getElementById("btnUpNormal").innerText = t.btn_reflect_editor;
        document.getElementById("btnUpSpreadsheet").innerText =
          t.btn_reflect_tsv;
        document.getElementById("ui-btn-copy-prompt").innerText =
          t.btn_copy_prompt;
        document.getElementById("ui-strip-headers").innerText = t.strip_headers;
        document.getElementById("ui-append-break").innerText = t.append_break;
        document.getElementById("ui-copy-1").innerText = t.copy;
        document.getElementById("ui-copy-2").innerText = t.copy;

        if (tagDatabase.length > 0) updateStatusBtn(true);
        updateLegend();
        searchTags(); // æ¤œç´¢çµæœã®ç¿»è¨³ãƒ©ãƒ™ãƒ«ãªã©ã‚‚æ›´æ–°
      }

      function updateStatusBtn(success) {
        const btn = document.getElementById("statusBtn");
        const t = translations[currentLang];
        if (success) {
          btn.innerText = t.success.replace(
            "{n}",
            tagDatabase.length.toLocaleString(),
          );
          btn.style.backgroundColor = "var(--copy-success-bg)";
          btn.style.color = "#fff";
        } else {
          btn.innerText = t.error;
          btn.style.backgroundColor = "#e74c3c";
        }
      }

      async function fetchFromDB() {
        const btn = document.getElementById("statusBtn");
        btn.innerText = translations[currentLang].loading;
        try {
          const response = await fetch("danboru_dictionary.json");
          if (!response.ok) throw new Error();
          const data = await response.json();
          tagDatabase = data.tags;
          tagMap = new Map(
            tagDatabase.map((i) => [
              i.t.trim().toLowerCase().replace(/_/g, " "),
              i.c,
            ]),
          );
          allThresholds = data.thresholds;
          updateStatusBtn(true);
          updateLegend();
          document.getElementById("tagSearch").disabled = false;
        } catch (err) {
          updateStatusBtn(false);
        }
      }

      function updateLegend() {
        const legendArea = document.getElementById("legendArea");
        if (!allThresholds.length) return;
        legendArea.innerHTML = allThresholds
          .map((t) => {
            // ãƒ©ãƒ™ãƒ«å†…ã® (S), (A) ç­‰ã‚’è¨€èªã«åˆã‚ã›ã¦èª¿æ•´ã—ãŸã‘ã‚Œã°ã“ã“ã§è¡Œã†ãŒã€
            // ç¾çŠ¶ã® thresholds.json ã® label ã‚’ãã®ã¾ã¾ä½¿ã£ã¦ã‚‚è¨˜å·ãªã®ã§é€šã˜ã‚‹ã€‚
            return `<div class="legend-item" title="${t.minCount.toLocaleString()} +">
                    <span class="color-dot" style="background-color: ${t.colorCode}"></span>
                    <span>${t.label.split("(")[0]}</span>
                  </div>`;
          })
          .join("");
      }

      // --- ä»¥ä¸‹ã€æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’çµ±åˆ (ä¸€éƒ¨UIãƒ†ã‚­ã‚¹ãƒˆå‚ç…§ã‚’ä¿®æ­£) ---

      function initTheme() {
        if (localStorage.getItem("theme") === "dark") {
          document.body.classList.add("dark-mode");
          document.getElementById("darkModeToggle").checked = true;
        }
      }
      function toggleDarkMode() {
        const isDark = document.getElementById("darkModeToggle").checked;
        document.body.classList.toggle("dark-mode", isDark);
        localStorage.setItem("theme", isDark ? "dark" : "light");
      }

      function switchTab(mode) {
        document
          .getElementById("tabSpreadsheet")
          .classList.toggle("active", mode === "spreadsheet");
        document
          .getElementById("tabNormal")
          .classList.toggle("active", mode === "normal");
        document.getElementById("areaSpreadsheet").style.display =
          mode === "spreadsheet" ? "block" : "none";
        document.getElementById("areaNormal").style.display =
          mode === "normal" ? "block" : "none";
        document.getElementById("stripOption").style.display =
          mode === "spreadsheet" ? "block" : "none";
        document.getElementById("breakOption").style.display =
          mode === "normal" ? "block" : "none";
        document.getElementById("btnUpNormal").style.display =
          mode === "normal" ? "block" : "none";
        document.getElementById("btnUpSpreadsheet").style.display =
          mode === "spreadsheet" ? "block" : "none";
        currentMode = mode;
      }
      let currentMode = "normal";

      function getColorByCount(count) {
        for (let t of allThresholds) {
          if (count >= t.minCount && count < t.maxCount) return t.colorCode;
        }
        return "#e74c3c";
      }

      function escapeHTML(str) {
        return str
          ? str
              .toString()
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
          : "";
      }

      function splitTagsSmart(line) {
        let result = [];
        let current = "";
        let depth = 0;
        let angle = 0;
        let comment = "";
        const hIdx = line.indexOf("#");
        if (hIdx !== -1) {
          comment = line.substring(hIdx).trim();
          line = line.substring(0, hIdx);
        }
        let pLine = line
          .replace(
            /\b(BREAK|AND|ADDROW|ADDCOMM|ADDCOL|ADDBASE)\b/gi,
            " , $1 , ",
          )
          .replace(/(<[^>]+>)/g, " , $1 , ");
        for (let char of pLine) {
          if (char === "(" || char === "[" || char === "{") depth++;
          else if (char === ")" || char === "]" || char === "}")
            depth = Math.max(0, depth - 1);
          else if (char === "<") angle++;
          else if (char === ">") angle = Math.max(0, angle - 1);
          if (char === "," && depth === 0 && angle === 0) {
            if (current.trim()) result.push(current.trim());
            current = "";
          } else {
            current += char;
          }
        }
        if (current.trim()) result.push(current.trim());
        if (comment) result.push(comment);
        return result.filter((t) => t !== "");
      }

      function createTagElement(rawTag) {
        const span = document.createElement("span");
        span.className = "prompt-tag";
        span.draggable = true;
        span.dataset.raw = rawTag;
        span.onclick = () => copyTag(rawTag, span);

        if (rawTag.startsWith("#")) {
          span.style.borderColor = "#27ae60";
          span.style.color = "#27ae60";
          span.textContent = rawTag;
          return span;
        }
        if (rawTag.startsWith("<") && rawTag.endsWith(">")) {
          span.style.borderColor = "#e84393";
          span.style.color = "#e84393";
          span.textContent = rawTag;
          return span;
        }

        const ctrl = ["break", "and", "addrow", "addcomm", "addcol", "addbase"];
        if (ctrl.includes(rawTag.toLowerCase())) {
          span.style.borderColor = "#e84393";
          span.style.color = "#e84393";
          span.textContent = rawTag;
          return span;
        }

        const clean = rawTag
          .replace(/[(){}[\]]/g, "")
          .split(":")[0]
          .trim()
          .toLowerCase()
          .replace(/_/g, " ");
        const color = getColorByCount(tagMap.get(clean) || 0);
        span.style.borderColor = color;
        span.style.color = color;
        span.textContent = rawTag;
        return span;
      }

      function convert() {
        const out = document.getElementById("outputPreview");
        out.innerHTML = "";
        let lines = [];
        if (currentMode === "spreadsheet") {
          const val = document.getElementById("inputSpreadsheet").value;
          const strip = document.getElementById("stripHeaders").checked;
          val.split("\n").forEach((l) => {
            let m = l.match(/^([^\t]+)\t+(.+)$/);
            if (m) {
              if (!strip) lines.push("# " + m[1].trim());
              lines.push(m[2].trim().replace(/\t/g, ", "));
            }
          });
        } else {
          lines = document
            .getElementById("inputNormal")
            .value.split("\n")
            .filter((l) => l.trim());
          if (document.getElementById("appendBreak").checked) {
            lines = lines.map((l) =>
              l.toLowerCase().includes("break") ? l : l + ", BREAK",
            );
          }
        }

        lines.forEach((l) => {
          const row = document.createElement("div");
          row.className = "prompt-row";
          row.draggable = true;
          const handle = document.createElement("div");
          handle.className = "row-handle";
          handle.innerHTML = "â‰¡";
          handle.style.cursor = "grab";
          handle.style.color = "#888";
          handle.style.paddingRight = "5px";
          row.appendChild(handle);
          splitTagsSmart(l).forEach((t) =>
            row.appendChild(createTagElement(t)),
          );
          out.appendChild(row);
        });
        syncPreviewToData();
      }

      function reflectToNormal() {
        syncPreviewToData();
        document.getElementById("inputNormal").value =
          document.getElementById("outputRaw").value;
      }
      function reflectToSpreadsheet() {
        let tsv = [];
        document.querySelectorAll(".prompt-row").forEach((row) => {
          let tags = Array.from(row.querySelectorAll(".prompt-tag")).map(
            (t) => t.dataset.raw,
          );
          if (tags.length) tsv.push(tags.join("\t"));
        });
        document.getElementById("inputSpreadsheet").value = tsv.join("\n");
      }

      function syncPreviewToData() {
        let allLines = [];
        document.querySelectorAll(".prompt-row").forEach((row) => {
          let tags = Array.from(row.querySelectorAll(".prompt-tag")).map(
            (t) => t.dataset.raw,
          );
          if (tags.length) allLines.push(tags.join(", "));
        });
        document.getElementById("outputRaw").value = allLines.join("\n");
      }

      function universalCopy(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        return Promise.resolve();
      }

      function copyResult(id, btn) {
        const t = translations[currentLang];
        universalCopy(document.getElementById(id).value).then(() => {
          const old = btn.innerText;
          btn.innerText = t.copied;
          btn.style.background = "var(--copy-success-bg)";
          btn.style.color = "#fff";
          setTimeout(() => {
            btn.innerText = old;
            btn.style.background = "";
            btn.style.color = "";
          }, 1000);
        });
      }

      function copyTag(tag, el) {
        universalCopy(tag);
        const old = el.style.background;
        el.style.background = "rgba(255,255,255,0.2)";
        setTimeout(() => (el.style.background = old), 200);
      }

      function searchTags() {
        const q = document.getElementById("tagSearch").value.toLowerCase();
        const res = document.getElementById("searchResult");
        if (!q) {
          res.innerHTML = "";
          return;
        }
        const matched = tagDatabase
          .filter((i) => i.t.includes(q) || (i.tr && i.tr.includes(q)))
          .slice(0, 50);
        res.innerHTML = matched
          .map(
            (i) => `
          <div class="tag-item" draggable="true" data-tag="${i.t}" onclick="copyTag('${i.t}', this)">
            <span style="font-weight:bold">${i.t}</span>
            <span style="float:right; color:${getColorByCount(i.c)}">${i.c.toLocaleString()}</span>
            <div style="font-size:0.8em; color:#888">${i.tr || ""}</div>
          </div>
        `,
          )
          .join("");
      }

      function initDragAndDrop() {
        let dragged = null;
        document.addEventListener("dragstart", (e) => {
          if (
            e.target.classList.contains("prompt-tag") ||
            e.target.classList.contains("prompt-row")
          ) {
            dragged = e.target;
            e.target.style.opacity = "0.5";
          }
          if (e.target.classList.contains("tag-item")) {
            e.dataTransfer.setData("text/plain", e.target.dataset.tag);
          }
        });
        document.addEventListener("dragend", (e) => {
          if (dragged) {
            dragged.style.opacity = "";
            dragged = null;
          }
          syncPreviewToData();
        });
        document.addEventListener("dragover", (e) => e.preventDefault());
        document.addEventListener("drop", (e) => {
          e.preventDefault();
          const tagText = e.dataTransfer.getData("text/plain");
          const row = e.target.closest(".prompt-row");
          if (tagText && row) {
            row.appendChild(createTagElement(tagText));
            syncPreviewToData();
          }
        });
      }
      function toggleBreaks() {
        convert();
      }
    </script>
  </body>
</html>
